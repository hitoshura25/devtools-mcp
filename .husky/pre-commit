#!/usr/bin/env sh

# Changeset enforcement hook
echo "üîç Checking for changesets..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any source files are being committed
SOURCE_FILES=$(echo "$STAGED_FILES" | grep -E '(packages/.*/src/|\.ts$|\.tsx$)' || true)

# Skip check if no source files or on main branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ -z "$SOURCE_FILES" ] || [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo "‚úÖ Skipping changeset check"
  exit 0
fi

# Check for changeset files (excluding README)
CHANGESET_FILES=$(find .changeset -name '*.md' ! -name 'README.md' 2>/dev/null | wc -l | tr -d ' ')

if [ "$CHANGESET_FILES" -gt 0 ]; then
  echo "‚úÖ Changeset found!"
  exit 0
fi

# No changeset - prompt to create one
echo ""
echo "üìù No changeset found. Let's create one now!"
echo ""

# Run changeset interactively
pnpm changeset

# Check if changeset was created
CHANGESET_FILES=$(find .changeset -name '*.md' ! -name 'README.md' 2>/dev/null | wc -l | tr -d ' ')

if [ "$CHANGESET_FILES" -gt 0 ]; then
  # Auto-add the changeset file
  git add .changeset/*.md
  echo ""
  echo "‚úÖ Changeset created and staged!"
  exit 0
else
  echo ""
  echo "‚ùå No changeset was created. Commit aborted."
  echo ""
  echo "If this change doesn't need a release, run:"
  echo "  pnpm changeset --empty"
  exit 1
fi
